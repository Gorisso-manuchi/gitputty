(self.webpackChunkvk=self.webpackChunkvk||[]).push([[9567],{41281:function(e,t,n){"use strict";var s=n(75105),i=function(){function e(){this.onCountChange=(0,s.default)(),this.isCountWasChanged=!1,this.count=0}return e.prototype.updateCount=function(e){this.isCountWasChanged=!0,this.count=e,this.onCountChange(e)},e.prototype.getCount=function(){return this.count},e}();window.BestFriends=new i;var r=n(93736),o=n(39871),d=n(49598),a=n(59336),l=n(25809),c=n(81294),u=n(62641);var f=n(33748);var v=n(31931),F=n(90893),h=n(72107);function _(e){void 0===e&&(e={});var t=!e.isAllConversationsLoaded&&!e.isSearchMode,n=!e.isSearchMode,s=e.conversationsList&&e.conversationsList.length?[(0,a.default)(),(0,h.default)({inner:[e.conversationsList.map((t=>function(e){void 0===e&&(e={});var t=e.conversation||{},n=t.userIds&&t.userIds.length||0,s=(0,u.getLangNumeric)(n,(0,u.getLang)("mobile_best_friends_edit_box_conversation_friends_count","raw")),i=!e.isSelected&&!e.isAddBestFriendsAvailable,r=(0,u.classNames)("BestFriendsEditBoxConversationItem","BestFriendsEditBoxItem",{"BestFriendsEditBoxConversationItem--selected":e.isSelected,"BestFriendsEditBoxConversationItem--disabled":i}),o=e.isSelected?(0,u.getLang)("mobile_best_friends_edit_box_conversation_delete_button_text"):(0,u.getLang)("mobile_best_friends_edit_box_conversation_add_button_text");return(0,l.default)({mix:r,attrs:{"data-conversation-id":t.peerId},onClick:[e.onConversationActionClick,t.peerId],img:t.photoUrl,title:Wd.wrap(t.name),subtitle:s,link:e.isSearchMode?null:(0,c.default)({inner:[o],disabled:i,class:"BestFriendsEditBoxConversationItem__actionButton",theme:e.isSelected?"tertiary":"outline"})})}({conversation:t,isSelected:(0,u.arrayIncludes)(e.selectedConversationsIds,t.peerId),isSearchMode:e.isSearchMode,isAddBestFriendsAvailable:e.isAddBestFriendsAvailable,onConversationActionClick:e.onConversationActionClick}))),t?(0,c.default)({inner:[(0,u.getLangNumeric)(e.moreConversationsCount,(0,u.getLang)("mobile_best_friends_edit_box_conversations_load_more_button_text","raw"))],theme:"tertiary",class:"BestFriendsEditBoxSource__loadMoreButton",icon:(0,f.Icon28ChevronDownOutline)(),onClick:e.onLoadMoreConversationsClick,use_native_onclick:!0}):null],mix:"BestFriendsEditBoxSource BestFriendsEditBoxSource--conversations",no_caps_for_title:!0,title:(0,u.getLang)("mobile_best_friends_edit_box_conversations_header")})]:null,i=e.friendsList&&e.friendsList.length?[(0,a.default)(),(0,h.default)({inner:[e.friendsList.map((t=>function(e){void 0===e&&(e={});var t=e.friend||{},n=!e.isSelected&&!e.isAddBestFriendsAvailable,s=(0,u.classNames)("BestFriendsEditBoxFriendItem","BestFriendsEditBoxItem",{"BestFriendsEditBoxFriendItem--selected":e.isSelected,"BestFriendsEditBoxFriendItem--disabled":n}),i=(0,u.classNames)("BestFriendsEditBoxFriendItem__checkbox",{"BestFriendsEditBoxFriendItem__checkbox--checked":e.isSelected,"BestFriendsEditBoxFriendItem__checkbox--disabled":n});return(0,l.default)({mix:s,attrs:{"data-friend-id":t.id},onClick:[e.onFriendActionClick,t.id],img:t.photoUrl,title:Wd.wrap(t.name),link:e.isSearchMode?null:{inner:[e.isSelected?(0,f.Icon24CheckCircleOn)():(0,f.Icon24CheckCircleOff)()],class:i,tag:"div"}})}({friend:t,isSelected:(0,u.arrayIncludes)(e.bestFriendsIds,t.id),isSearchMode:e.isSearchMode,isAddBestFriendsAvailable:e.isAddBestFriendsAvailable,onFriendActionClick:e.onFriendActionClick})))],mix:"BestFriendsEditBoxSource BestFriendsEditBoxSource--friends",no_caps_for_title:!0,corner:n?{onclick:e.onClearBestFriendsButtonClick,text:(0,u.getLang)("mobile_best_friends_edit_box_best_friends_clear_button_text"),class:"BestFriendsEditBoxSource__headerAction"}:null,title:(0,u.getLang)("mobile_best_friends_edit_box_friends_header")})]:null;return{inner:[e.isDataLoaded?null:{inner:[(0,v.default)()],class:"BestFriendsEditBox__locker",tag:"div"},e.isDataLoaded?{inner:[(0,F.default)({mix:"BestFriendsEditBoxSearchInput",on_change:e.onSearchInputChange,value:e.query,icon:(0,f.Icon16Search)(),placeholder:(0,u.getLang)("mobile_best_friends_edit_box_search_input_label")}),e.isSearchNotFound?null:{inner:[(0,u.getLang)("mobile_best_friends_edit_box_description")],class:"BestFriendsEditBox__description",tag:"div"},s,i],class:"BestFriendsEditBox__content",tag:"div"}:null,e.isSearchNotFound?{inner:[(0,u.getLang)("mobile_best_friends_edit_box_search_not_found")],class:"BestFriendsEditBoxSearchNotFound",tag:"div"}:null],class:"BestFriendsEditBox",ref:e.bestFriendsEditBoxRef,tag:"div"}}var p,B=n(79573),C=100;!function(e){e.ADD="add",e.DELETE="delete"}(p||(p={}));var g=n(2947),m=n(20848),b=n(80235),L=n(57141),S=n(40983),I=function(e){function t(t){var n=e.call(this,t)||this;return n.nextFriendsStartFrom=40,n.nextConversationsStartFrom=2,n.onStateChange=(0,s.default)(),n.bestFriendsEditBoxRef=(0,g.createRef)(),n.setSubmitButtonDisabled=function(e){var t;void 0===e&&(e=!0);var s=null===(t=n.bestFriendsEditBoxRef)||void 0===t?void 0:t.current.closest(".ModalPage").querySelector(".ModalPage__headerButton--confirm");s&&c.default.setDisabled(s,e)},n.loadMoreFriends=function(){return new Promise((function(e){if(!n.state.isAllFriendsLoaded&&!n.state.isSearchMode){var t=n.data.friendsList.slice(n.nextFriendsStartFrom,n.nextFriendsStartFrom+40),s=n.mergeFriendsLists(n.state.friendsList,t);n.setState({friendsList:s,isAllFriendsLoaded:s.length>=n.data.friendsList.length}),n.nextFriendsStartFrom=n.nextFriendsStartFrom+40,e()}}))},n.loadMoreConversations=function(){if(!n.state.isAllConversationsLoaded){var e=n.data.conversationsList.slice(n.nextConversationsStartFrom,n.nextConversationsStartFrom+5),t=n.mergeConversationsList(n.state.conversationsList,e);n.setState({conversationsList:t,isAllConversationsLoaded:t.length>=n.data.conversationsList.length,moreConversationsCount:n.getMoreConversationsCount(n.data.conversationsList.length,t.length)}),n.nextConversationsStartFrom=n.nextConversationsStartFrom+5}},n.search=function(e){var t=e.currentTarget.value;return n.state.isSearchMode||""!==(t=t.trim())?new Promise((function(e){if("string"==typeof t&&0!==t.length){n.conversationsListBeforeSearch||(n.conversationsListBeforeSearch=n.state.conversationsList),n.friendsListBeforeSearch||(n.friendsListBeforeSearch=n.state.friendsList);var s=n.data.conversationsList.filter((function(e){return e.name.toLowerCase().includes(t.toLowerCase().trim())})),i=n.data.friendsList.filter((function(e){return e.name.toLowerCase().includes(t.toLowerCase().trim())}));n.setState({query:t,isSearchMode:!0,isSearchNotFound:!s.length&&!i.length,conversationsList:s,friendsList:i}),e()}else n.endSearch(e)})):(n.setState({query:t}),Promise.resolve())},n.removeBestFriend=function(e){var t=n.state.bestFriendsIds.filter((function(t){return t!==e}));n.setState({bestFriendsIds:t,isAddBestFriendsAvailable:t.length<C,selectedConversationsIds:n.getConversationsIdsWhereAllFriendsExists(t)})},n.addBestFriend=function(e,t){void 0===t&&(t=!1);var s=n.state.friendsList;if(t){var i=n.data.friendsList.find((function(t){return t.id===e}));s=n.getFriendsListOrderedByFriendsIds(n.mergeFriendsLists(i?[i]:[],n.state.friendsList),[e])}var r=Array.from(new Set(n.state.bestFriendsIds.concat(e)));n.setState({friendsList:s,bestFriendsIds:r,isAddBestFriendsAvailable:r.length<C,selectedConversationsIds:n.getConversationsIdsWhereAllFriendsExists(r)})},n.isBestFriendSelected=function(e){return n.state.bestFriendsIds.includes(e)},n.removeBestFriendsFromConversation=function(e){var t=n.data.conversationsList.find((function(t){return t.peerId===e}));if(t){var s=n.state.bestFriendsIds.filter((function(e){return!t.userIds.includes(e)}));n.setState({bestFriendsIds:s,isAddBestFriendsAvailable:s.length<C,selectedConversationsIds:n.getConversationsIdsWhereAllFriendsExists(s)})}},n.addBestFriendsFromConversation=function(e,t){void 0===t&&(t=!1);var s=n.data.conversationsList.find((function(t){return t.peerId===e}));if(s){var i=n.state.conversationsList;t&&(i=n.getConversationsListOrderedByConversationsIds(n.mergeConversationsList(n.state.conversationsList,[s]),[e]));var r=n.getFriendsListOrderedByFriendsIds(n.mergeFriendsLists(n.data.friendsList.filter((function(e){return s.userIds.includes(e.id)})).sort((function(e,t){return e.id-t.id})),n.state.friendsList),s.userIds),o=Array.from(new Set(n.state.bestFriendsIds.concat(s.userIds)));n.setState({conversationsList:i,isAllConversationsLoaded:i.length>=n.data.conversationsList.length,friendsList:r,bestFriendsIds:o,isAddBestFriendsAvailable:o.length<C,selectedConversationsIds:n.getConversationsIdsWhereAllFriendsExists(o)})}},n.isConversationSelected=function(e){return n.state.selectedConversationsIds.includes(e)},n.clearBestFriendsList=function(){n.setState({bestFriendsIds:[],isAddBestFriendsAvailable:!0,selectedConversationsIds:[]})},n.submit=function(){(0,b.sendBestFriendsAnalytic)(b.BestFriendsEventType.saveBestFriendsList);var e=n.state.bestFriendsIds,t=null,s=function(e){void 0===e&&(e=!1),e&&(0,b.sendBestFriendsAnalytic)(b.BestFriendsEventType.updatePopupSave),t&&d.default.close(t),n.setSubmitButtonDisabled(),n.saveBestFriends().then((function(e){var t,s,i;null===(t=window.BestFriendsEditBox)||void 0===t||t.closePopup(),n.config.showSuccessSnackbar&&L.init({type:L.SNACKBAR_TYPE_SUCCESS,text:(0,u.getLang)("mobile_best_friends_list_saved")}),null===(s=window.BestFriends)||void 0===s||s.updateCount(e.bestFriendsCount),o.default.handle(null===(i=n.config)||void 0===i?void 0:i.onSubmit,e)})).catch(console.error)};e.length?t=(0,S.Confirm)((0,u.getLang)("mobile_wall_best_friends_settings_box_confirm_description"),(function(){return s(!0)}),(function(){(0,b.sendBestFriendsAnalytic)(b.BestFriendsEventType.updatePopupCancel),t&&d.default.close(t)}),{yes_label:(0,u.getLang)("mobile_wall_best_friends_settings_box_confirm_save_label"),title:(0,u.getLang)("mobile_wall_best_friends_settings_box_confirm_save")}):s()},n.onConversationActionClick=function(e){var t=n.state,s=t.isAddBestFriendsAvailable;if(t.isSearchMode)return(0,b.sendBestFriendsAnalytic)(b.BestFriendsEventType.selectChatFromSearch),void n.endSearch((function(){s&&(n.addBestFriendsFromConversation(e,!0),n.animateReorderedItems(n.getFriendsIdsFromConversations(e),"data-friend-id"),n.animateReorderedItems([e],"data-conversation-id"))}));(0,b.sendBestFriendsAnalytic)(b.BestFriendsEventType.addFriendsFromChat),n.isConversationSelected(e)?n.removeBestFriendsFromConversation(e):s&&(n.addBestFriendsFromConversation(e),n.animateReorderedItems(n.getFriendsIdsFromConversations(e),"data-friend-id"))},n.onFriendActionClick=function(e){var t=n.state,s=t.isAddBestFriendsAvailable;if(t.isSearchMode)return(0,b.sendBestFriendsAnalytic)(b.BestFriendsEventType.selectFriendFromSearch),void n.endSearch((function(){s&&(n.addBestFriend(e,!0),n.animateReorderedItems([e],"data-friend-id"))}));n.isBestFriendSelected(e)?n.removeBestFriend(e):s&&n.addBestFriend(e)},n.onLoadMoreConversationsClick=function(){(0,b.sendBestFriendsAnalytic)(b.BestFriendsEventType.moreChats),n.loadMoreConversations()},n.onClearBestFriendsButtonClick=function(){(0,b.sendBestFriendsAnalytic)(b.BestFriendsEventType.clear),n.clearBestFriendsList()},n.config=n.props.config,n.state={bestFriendsIds:[],isAddBestFriendsAvailable:!0,selectedConversationsIds:[],friendsList:[],totalFriendsCount:0,isAllFriendsLoaded:!1,conversationsList:[],totalConversationsCount:0,isAllConversationsLoaded:!1,moreConversationsCount:0,query:"",isSearchMode:!1,isSearchNotFound:!1,isDataLoaded:!1},n}return(0,B.__extends)(t,e),t.prototype.componentDidMount=function(){var e=this;this.addSubmitButtonClickListener(),this.setSubmitButtonDisabled(),this.initAutoScroll(),this.loadData().then((function(t){e.data=e.prepareData(t);var n=e.data.bestFriendsIds.length?e.data.bestFriendsIds:e.data.friendsList.slice(0,10).map((function(e){return e.id}));e.setState({bestFriendsIds:n,isAddBestFriendsAvailable:n.length<C,selectedConversationsIds:e.getConversationsIdsWhereAllFriendsExists(e.data.bestFriendsIds),friendsList:e.data.friendsList.slice(0,40),totalFriendsCount:e.data.friendsList.length,isAllFriendsLoaded:e.data.friendsList.length<=40,conversationsList:e.data.conversationsList.slice(0,2),totalConversationsCount:e.data.conversationsList.length,isAllConversationsLoaded:e.data.conversationsList.length<=2,moreConversationsCount:e.getMoreConversationsCount(e.data.conversationsList.length,2),isDataLoaded:!0})})).catch(console.error)},t.prototype.componentWillUpdate=function(e,t){this.setSubmitButtonDisabled(!this.isSubmitAvailable(t))},t.prototype.addSubmitButtonClickListener=function(){var e,t=null===(e=this.bestFriendsEditBoxRef)||void 0===e?void 0:e.current.closest(".ModalPage").querySelector(".ModalPage__headerButton--confirm");null==t||t.addEventListener("click",this.submit)},t.prototype.initAutoScroll=function(){var e,t,n=this,s=null;null===(t=null===(e=this.bestFriendsEditBoxRef)||void 0===e?void 0:e.current.closest(".ModalPage__content"))||void 0===t||t.addEventListener("scroll",(function(e){null==s||s((0,m.getY)(e.currentTarget)+e.currentTarget.scrollTop)})),(0,m.initAutoScroll)((function(){var e,t=null===(e=n.bestFriendsEditBoxRef)||void 0===e?void 0:e.current.querySelectorAll(".BestFriendsEditBoxSource--friends .BestFriendsEditBoxFriendItem");if(t)return t[t.length-1]}),this.loadMoreFriends,{onScroll:function(e){return s=e}})},t.prototype.endSearch=function(e){this.setState({query:"",isSearchMode:!1,isSearchNotFound:!1,conversationsList:this.conversationsListBeforeSearch,friendsList:this.friendsListBeforeSearch},e),delete this.conversationsListBeforeSearch,delete this.friendsListBeforeSearch},t.prototype.animateReorderedItems=function(e,t){var n=this;requestAnimationFrame((function(){e.map((function(e){var s,i=null===(s=n.bestFriendsEditBoxRef)||void 0===s?void 0:s.current.querySelector(".BestFriendsEditBoxItem["+t+'="'+e+'"]');return null==i||i.classList.add("BestFriendsEditBoxItem--reordered"),i}))}))},t.prototype.isSubmitAvailable=function(e){var t=function(e){return null==e?void 0:e.map((function(e){return e})).sort((function(e,t){return e-t})).join(",")};return t(e.bestFriendsIds)!==t(this.data.bestFriendsIds)&&e.bestFriendsIds.length<=C},t.prototype.getBatchOperationsToSave=function(){var e=this,t=this.data.bestFriendsIds.reduce((function(t,n){return e.state.bestFriendsIds.includes(n)||t.push({op:p.DELETE,user_id:n}),t}),[]),n=this.state.bestFriendsIds.reduce((function(t,n){return e.data.bestFriendsIds.includes(n)||t.push({op:p.ADD,user_id:n}),t}),[]);return(0,B.__spreadArray)((0,B.__spreadArray)([],(0,B.__read)(t),!1),(0,B.__read)(n),!1)},t.prototype.getFriendsIdsFromConversations=function(e){var t=this.data.conversationsList.find((function(t){return t.peerId===e}));return t?t.userIds:[]},t.prototype.saveBestFriends=function(){var e=this;return new Promise((function(t,n){var s=e.getBatchOperationsToSave();window.ajax.post("wall.php",{act:"edit_best_friends",batch:JSON.stringify(s),hash:e.data.editHash},{onDone:function(e){t(e)},onFail:function(e){return n(e),!0}})}))},t.prototype.loadData=function(){return new Promise((function(e,t){window.ajax.post("wall.php",{act:"get_best_friends_box_data"},{onDone:function(t,n,s,i){e({friendsList:t,conversationsList:s,bestFriendsIds:n,editHash:i})},onFail:function(e){return t(e),!0}})}))},t.prototype.prepareData=function(e){return(0,B.__assign)((0,B.__assign)({},e),{friendsList:this.getFriendsListOrderedByFriendsIds(e.friendsList,e.bestFriendsIds)})},t.prototype.getConversationsIdsWhereAllFriendsExists=function(e){return this.data.conversationsList.reduce((function(t,n){var s,i;try{for(var r=(0,B.__values)(n.userIds),o=r.next();!o.done;o=r.next()){var d=o.value;if(!e.includes(d))return t}}catch(e){s={error:e}}finally{try{o&&!o.done&&(i=r.return)&&i.call(r)}finally{if(s)throw s.error}}return t.push(n.peerId),t}),[])},t.prototype.mergeFriendsLists=function(e,t){return Array.from(new Map((0,B.__spreadArray)((0,B.__spreadArray)([],(0,B.__read)(e),!1),(0,B.__read)(t),!1).map((function(e){return[e.id,e]}))).values())},t.prototype.mergeConversationsList=function(e,t){return Array.from(new Map((0,B.__spreadArray)((0,B.__spreadArray)([],(0,B.__read)(e),!1),(0,B.__read)(t),!1).map((function(e){return[e.peerId,e]}))).values())},t.prototype.getFriendsListOrderedByFriendsIds=function(e,t){return e.reduce((function(e,n){return t.includes(n.id)?e.unshift(n):e.push(n),e}),[])},t.prototype.getConversationsListOrderedByConversationsIds=function(e,t){return e.reduce((function(e,n){return t.includes(n.peerId)?e.unshift(n):e.push(n),e}),[])},t.prototype.getMoreConversationsCount=function(e,t){return Math.min(e-t,5)},t.prototype.render=function(){return o.default.preact(_,(0,B.__assign)((0,B.__assign)({},this.state),{bestFriendsEditBoxRef:this.bestFriendsEditBoxRef,onLoadMoreConversationsClick:this.onLoadMoreConversationsClick,onClearBestFriendsButtonClick:this.onClearBestFriendsButtonClick,onSearchInputChange:this.search,onConversationActionClick:this.onConversationActionClick,onFriendActionClick:this.onFriendActionClick}))},t}(g.Component),x=function(){function e(){var e=this;this.close=function(t){var n;t&&console.error(t),e.closePopup(),o.default.handle(null===(n=e.config)||void 0===n?void 0:n.onClose)}}return e.prototype.open=function(e){var t;if(this.config=e,!this.editBoxPopup){var n=(0,r.default)({title:(0,u.getLang)("mobile_best_friends_edit_box_header"),content:_(),isLeftActionBack:!0,onLeftActionClick:"BestFriendsEditBox.close",isConfirmActionAvailable:!0}),s=o.default.elem(n);this.editBoxPopup=d.default.open(s,!0),o.default.mountPreactComponent(I,{config:this.config},null===(t=this.editBoxPopup)||void 0===t?void 0:t.querySelector(".ModalPage__content"))}},e.prototype.closePopup=function(){this.editBoxPopup&&(d.default.close(this.editBoxPopup),this.editBoxPopup=null)},e}();window.BestFriendsEditBox=new x},73295:function(e,t,n){"use strict";n(41281);var s=n(20848),i=function(){this.onFeedUploadInputChange=function(e,t,n){window.page.onChange((function n(){window.page.onChange("__clear",n),!window.mediaUpload.isUploading&&window.mediaUpload.start(e,t)})),(0,s.statlogsValueEvent)("mvk_feed_photo_upload","upload"),window.nav.go(n)},this.onSimpleUploadInputChange=function(e,t){window.page.onChange((function e(){var n=document.querySelector(".inline_upload[type=file]");n.files=t,window.page.onChange("__clear",e),!window.mediaUpload.isUploading&&window.mediaUpload.start(n)})),(0,s.statlogsValueEvent)("mvk_feed_photo_upload","upload"),window.nav.go(e)}};window.WallPosting=new i}},function(e){"use strict";e.O(0,[4578,1777,4736,5456,5790,3898,5411,6855,6199,490,410,6444,8592,7219,6429],(function(){return t=73295,e(e.s=t);var t}));e.O()}]);