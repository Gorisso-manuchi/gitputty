(self.webpackChunkvk=self.webpackChunkvk||[]).push([[2807],{1626:function(t,e,r){"use strict";var o=r(57649),n=r(72455),i=r(20848),a=r(79573),l=r(34757),s=r(61540),u=function(t,e,r,o,n,i,a,l,s,u,h){var c=l||o,d=s||n,p=u||i||e.naturalWidth,v=h||a||e.naturalHeight;t.beginPath(),t.arc(c+r,d+r,r,Math.PI,Math.PI+Math.PI/2),t.lineTo(c+p-r,d),t.arc(c+p-r,d+r,r,Math.PI+Math.PI/2,2*Math.PI),t.lineTo(c+p,d+v-r),t.arc(c+p-r,d+v-r,r,2*Math.PI,Math.PI/2),t.lineTo(c+r,d+v),t.arc(c+r,d+v-r,r,Math.PI/2,Math.PI),t.closePath(),t.save(),t.clip(),t.drawImage(e,o,n,i,a,l,s,u,h),t.restore()},h=function(t,e,r,o,n,i){var a={};if("number"==typeof i)a={tl:i,tr:i,br:i,bl:i};else{var l={tl:0,tr:0,br:0,bl:0};for(var s in l)a[s]=a[s]||l[s]}t.save(),t.beginPath(),t.moveTo(e+a.tl,r),t.lineTo(e+o-a.tr,r),t.quadraticCurveTo(e+o,r,e+o,r+a.tr),t.lineTo(e+o,r+n-a.br),t.quadraticCurveTo(e+o,r+n,e+o-a.br,r+n),t.lineTo(e+a.bl,r+n),t.quadraticCurveTo(e,r+n,e,r+n-a.bl),t.lineTo(e,r+a.tl),t.quadraticCurveTo(e,r,e+a.tl,r),t.closePath(),t.restore()};function c(t,e,r,o,n,i){return void 0===i&&(i=0),new Promise((function(a,l){("string"==typeof t?(0,s.loadImage)(t):Promise.resolve(t)).then((function(t){var u=document.createElement("canvas");u.width=90===i||270===i?t.naturalHeight:t.naturalWidth,u.height=90===i||270===i?t.naturalWidth:t.naturalHeight;var h=u.getContext("2d");if(h){h.fillStyle="#fff",h.fillRect(0,0,h.canvas.width,h.canvas.height),i?(h.translate(u.width/2,u.height/2),h.rotate(i*Math.PI/180),h.drawImage(t,-t.naturalWidth/2,-t.naturalHeight/2)):h.drawImage(t,0,0);var c=h.getImageData(e,r,o,n),d=document.createElement("canvas");d.width=o,d.height=n;var p=d.getContext("2d");if(p)return p.putImageData(c,0,0),(0,s.loadImage)(d.toDataURL("image/jpeg",1)).then(a).catch(l);a(t)}else a(t)})).catch(l)}))}function d(t,e,r){var o=Object.assign({},{pollStickerX:157,pollStickerY:1075,pollStickerWidth:760,pollStickerHeight:391,pollStickerOffset:45},r||{}),n=o.pollStickerX,i=o.pollStickerY,a=o.pollStickerWidth,l=o.pollStickerHeight+o.pollStickerOffset;return{type:"poll",poll_id:e,poll_owner_id:t,clickable_area:[{x:n,y:i},{x:n+a,y:i},{x:n+a,y:i+l},{x:n,y:i+l}]}}var p={title:"",titleColor:"#000",titleAlign:"center",titleFontSize:58,titleFont:"TT Commons",voteButtonText:window.getLang("stories_poll_sticker_vote_button_text"),voteButtonTextAlign:"center",voteButtonTextColor:"#fff",voteButtonFontSize:49,voteButtonFont:"TT Commons",voteButtonBackgroundColor:"#3F8AE0",width:760,height:391,radius:50,offset:45,backgroundColor:"#fff",backgroundCircleColor:"#fff",backgroundCircleSize:90,foregroundCircleColor:"#3F8AE0",foregroundCircleSize:72};function v(t){return(0,s.loadImage)("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyNCIgZmlsbD0ibm9uZSI+PHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik04IDJhMiAyIDAgMTE0IDB2MjBhMiAyIDAgMTEtNCAwVjJ6bTggMTJhMiAyIDAgMTE0IDB2OGEyIDIgMCAxMS00IDB2LTh6TTIgOGEyIDIgMCAwMC0yIDJ2MTJhMiAyIDAgMTA0IDBWMTBhMiAyIDAgMDAtMi0yeiIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg==").then((function(e){var r=Object.assign({},v.defaultOptions,t||{}),o=r.title,n=r.titleColor,i=r.titleAlign,a=r.titleFontSize,l=r.titleFont,s=r.voteButtonText,u=r.voteButtonTextAlign,c=r.voteButtonTextColor,d=r.voteButtonFontSize,p=r.voteButtonFont,_=r.voteButtonBackgroundColor,f=r.width,g=r.height,w=r.radius,m=r.offset,b=r.backgroundColor,S=r.backgroundCircleColor,P=r.backgroundCircleSize,A=r.foregroundCircleColor,E=r.foregroundCircleSize,O=document.createElement("canvas"),C=O.getContext("2d");if(!C)return Promise.reject("canvas context not found");O.width=Number(f),O.height=Number(g)+Number(m),C.fillStyle=String(b||""),h(C,0,Number(m),Number(f),Number(g),Number(w)),C.fill(),C.fillStyle=String(S||""),C.beginPath(),C.arc(Number(f)/2,Number(P),Number(P),0,2*Math.PI,!1),C.fill(),C.fillStyle=String(A||""),C.beginPath(),C.arc(Number(f)/2,Number(P),Number(E),0,2*Math.PI,!1),C.fill();C.drawImage(e,Number(f)/2-27,Number(P)-36,54,72),C.save(),C.font="500 "+a+"px "+l,C.fillStyle=String(n||""),C.textAlign=String(i||""),C.fillText(o,Number(f)/2,230),C.restore(),C.save();var y=Number(f)-75,T=(Number(f)-y)/2,N=Number(g)+Number(m)-103-35;C.fillStyle=String(_||""),h(C,T,N,y,103,29),C.fill(),C.restore(),C.save();var x=Number(f)/2,I=Number(g)+Number(m)-103+30;return C.font="500 "+d+"px "+p,C.fillStyle=String(c||""),C.textAlign=String(u||""),C.fillText(String(s||""),x,I),C.restore(),O}))}v.defaultOptions=p;var _={newAvatarUrl:"",oldAvatarUrl:"",newAvatarStrokeWidth:17,newAvatarStrokeColor:"#fff",oldAvatarStrokeWidth:17,oldAvatarStrokeColor:"#fff",baseWidth:1080,baseHeight:1920,displayWidth:375,backgroundColor:"rgba(0, 0, 0, .16)",newAvatarInBackgroundBlur:160,avatarWidth:500,title:window.getLang("stories_new_avatar_story_title_header"),titleColor:"#fff",titleTextAlign:"center",titleFont:"TT Commons",titleFontSize:69,titleLineHeight:87,titleShadowOffsetX:0,titleShadowOffsetY:4,titleShadowBlur:12,titleShadowColor:"rgba(0, 0, 0, 0.24)",pollStickerX:157,pollStickerY:1075,blobImageType:"image/jpeg",blobQuality:1};function f(t,e){var r=Object.assign({},f.defaultOptions,t||{}),o=r.newAvatarUrl,n=r.oldAvatarUrl,i=r.newAvatarStrokeWidth,l=r.newAvatarStrokeColor,h=r.oldAvatarStrokeWidth,c=r.oldAvatarStrokeColor,d=r.baseWidth,p=r.baseHeight,_=r.displayWidth,g=r.backgroundColor,w=r.newAvatarInBackgroundBlur,m=r.avatarWidth,b=r.title,S=r.titleColor,P=r.titleTextAlign,A=r.titleFont,E=r.titleFontSize,O=r.titleLineHeight,C=r.titleShadowOffsetX,y=r.titleShadowOffsetY,T=r.titleShadowBlur,N=r.titleShadowColor,x=r.pollStickerX,I=r.pollStickerY,k=r.pollStickerOptions,U=r.blobImageType,L=r.blobQuality;d=d||Number(f.defaultOptions.baseWidth),p=p||Number(f.defaultOptions.baseHeight),_=_||Number(f.defaultOptions.displayWidth),k=Object.assign({},{title:window.getLang("stories_new_avatar_story_poll_sticker_title")},k||{});var M=_*(p/d),D=e||document.createElement("canvas"),R=D.getContext("2d");return R?(D.width=d,D.height=p,D.style.width=_+"px",D.style.height=M+"px",new Promise((function(t,e){(0,s.loadImages)([o,n]).then((function(r){var o=(0,a.__read)(r,2),n=o[0],d=o[1];R.clearRect(0,0,D.width,D.height),R.fillStyle=String(g||""),R.fillRect(0,0,D.width,D.height),R.save(),R.filter="blur("+w+"px)";var p,_,f,M,B,j,H,W,F,G=(p=n.naturalWidth,_=n.naturalHeight,f=D.width,M=D.height,(F=p/_)>f/M?(H=M,W=M*F):(W=f,H=f/F),{width:W,height:H,offsetLeft:(f-W)*(B=void 0===(B=.5)?.5:B),offsetTop:(M-H)*(j=void 0===(j=.5)?.5:j)});if(R.drawImage(n,G.offsetLeft,G.offsetTop,G.width,G.height),R.restore(),"none"!==R.filter){var z=(0,s.getAverageRGB)(R);R.fillStyle="rgb("+z.r+", "+z.g+", "+z.b+")",R.fillRect(0,0,D.width,D.height)}R.save(),R.shadowOffsetX=Number(C),R.shadowOffsetY=Number(y),R.shadowBlur=Number(T),R.shadowColor=String(N||""),R.font="600 "+E+"px/"+O+"px "+A,R.fillStyle=String(S||""),R.textAlign=String(P);var V=null==b?void 0:b.split("{br}");null==V||V.forEach((function(t,e){var r=Number(O)*e,o=D.width/2,n=D.height/2-Number(O)*V.length/2+r-395;R.fillText(t,o,n)})),R.restore();var X=(D.width-Number(m))/2,Y=Math.min(d.width,d.height),K=Math.min(n.width,n.height);R.save(),u(R,d,Number(m)/2,0,0,Y,Y,X-165,665,Number(m),Number(m)),R.lineWidth=Number(h),R.strokeStyle=String(c),R.stroke(),u(R,n,Number(m)/2,0,0,K,K,X+165,665,Number(m),Number(m)),R.lineWidth=Number(i),R.strokeStyle=String(l),R.stroke(),R.restore(),v(k).then((function(e){R.drawImage(e,Number(x),Number(I)),null==D||D.toBlob(t,U,L)})).catch(e)})).catch(e)}))):Promise.reject(new Error("canvas context not found"))}f.defaultOptions=_;var g=r(85701),w=r(57141),m=r(41319);var b={openNewAvatarStory:function(t,e,r){t.metaKey||t.ctrlKey||(t.preventDefault(),window.Stories.init(e+"/"+e+"_"+r,{source:m.StorySource.PROFILE_SNACKBAR}))},saveNewAvatarStory:function(t,e){return(0,g.saveStoryOnServer)(e,t.newAvatarStorySaveHash).then((function(t){return t.story})).catch((function(t){w.init({type:w.SNACKBAR_TYPE_ERROR,text:t&&t.message||(0,i.getLang)("global_error")})}))},initNewAvatarStory:function(t,e,r){return(0,l.addStatic)([t.newAvatarStoryFontsCssPath]).then((function(){return Promise.all([(0,s.loadFontFacePromise)("TT Commons",{weight:500}),(0,s.loadFontFacePromise)("TT Commons",{weight:600})])})).then((function(){return Promise.all([f({newAvatarUrl:r,oldAvatarUrl:t.currentPhoto,title:(0,i.getLang)("mobile_stories_new_avatar_story_title_header"),pollStickerOptions:{title:(0,i.getLang)("mobile_stories_new_avatar_story_poll_sticker_title"),voteButtonText:(0,i.getLang)("mobile_stories_poll_sticker_vote_button_text")}}),(o=t.newAvatarStoryCreatePollHash,new Promise((function(t,e){window.ajax.post((0,s.isMvk)()?"stories.php":"al_stories.php",{act:"create_new_avatar_poll",hash:o},{onDone:t,onError:e,onFail:e})}))).then((function(t){return t||Promise.reject()})).then((function(r){return(0,g.getStoryUploadUrl)({clickable_stickers:JSON.stringify({original_width:1080,original_height:1920,clickable_stickers:[d(e,r)]}),hash:t.newAvatarStoryUploadUrlHash,entry_point:m.StoryEntryPoint.CHANGE_AVATAR,ref:window.cur.module})}))]).then((function(t){var e=(0,a.__read)(t,2),r=e[0],o=e[1];return window.StoryPublisher.uploadStoryBlobToServer(r,o)}));var o}))}};window.NewAvatarStory=b;var S=r(11639),P=r(62641);function A(t){void 0===t&&(t={});var e=(0,P.winToUtf)(t.ownerName);return{inner:[{inner:[(0,P.getLang)("mobile_owner_avatar_edit_preview_header")],class:"OwnerAvatarEditPreview__header",tag:"div"},{inner:[{class:"OwnerAvatarEditPreviewThumbnail__preview",tag:"div"},{inner:[{inner:[e],class:"OwnerAvatarEditPreviewThumbnail__ownerName",tag:"div"},{inner:[(0,P.getLang)("mobile_owner_avatar_edit_preview_thumbnail_description")],class:"OwnerAvatarEditPreviewThumbnail__description",tag:"div"}],class:"OwnerAvatarEditPreviewThumbnail__content",tag:"div"}],class:"OwnerAvatarEditPreviewThumbnail",tag:"div"}],class:"OwnerAvatarEditPreview",tag:"div"}}var E=r(93736),O=r(39871),C=r(49598),y=r(81294),T=r(88833),N=r(4726);function x(t){void 0===t&&(t={});var e=t.avatarSrc,r=t.config||{},o=r.new_avatar_story_data&&r.new_avatar_story_data.shouldCreateNewAvatarStory;return{inner:[{inner:[(0,N.Avatar)({mix:"OwnerAvatarEditPublisherStep__avatar",size:192,src:e}),{inner:[r.description],class:"OwnerAvatarEditPublisherStep__description",tag:"div"}],class:"OwnerAvatarEditPublisherStep__previewWrapper",tag:"div"},{inner:[(0,T.default)({type:"switcher",name:"OwnerAvatarEditPublisherStepPublishPost",label:r.publish_post_checkbox_label,checked:!0,onChange:t.onPostPublishChange}),o?(0,T.default)({type:"switcher",name:"OwnerAvatarEditPublisherStepPublishStory",label:r.publish_story_checkbox_label,checked:!0,onChange:t.onStoryPublishChange}):null],class:"OwnerAvatarEditPublisherStep__checkboxes",tag:"div"},(0,y.default)({inner:[r.save_button_done],class:"OwnerAvatarEditPublisherStep__submitButton",size:"large",use_native_onclick:!0,onClick:t.onSaveClick})],class:"OwnerAvatarEditPublisherStep",tag:"div"}}var I,k=r(69351),U=r(19331),L=r(95001),M=r(79957);function D(t){var e={event_type:t};(0,M.statlogsValueEvent)("upload_photo_analytics",e)}!function(t){t.EVENT_SHARE_TO_STORY_TURN_OFF="share_to_story_turn_off",t.EVENT_SHARE_TO_STORY_TURN_ON="share_to_story_turn_on",t.EVENT_SHARE_TO_FEED_TURN_OFF="share_to_feed_turn_off",t.EVENT_SHARE_TO_FEED_TURN_ON="share_to_feed_turn_on"}(I||(I={}));var R=new(function(){function t(){var t=this;this.thumbnailCreatorHandler=function(e){var r;if(t.context.cropperResult=e,t.context.mode===k.OwnerAvatarEditorMods.UPLOAD||t.context.mode===k.OwnerAvatarEditorMods.SELECT)return(null===(r=t.context.publisherStep)||void 0===r?void 0:r.is_enabled)?t.openPublisherStep(e):t.saveOwnerAvatar().catch(console.error).then((function(e){var r,o,n=e[1];t.showDoneBoxAfterAvatarChange(!0,null===(o=null===(r=t.context.publisherStep)||void 0===r?void 0:r.new_avatar_story_data)||void 0===o?void 0:o.shouldCreateNewAvatarStory,null==n?void 0:n.ownerId,null==n?void 0:n.id)})).finally((function(){var e;null===(e=t.thumbnailCreator)||void 0===e||e.close(),t.closePublisherStep()})),!0;var o=e.crop,i=(0,n.getCropString)(o.x,o.y,o.width,o.height,!1);return t.sendCropUpdate(t.context.ownerId,i,t.context.hash||"").then((function(t){t[0]&&window.nav.go(t[0])}))},this.onPostPublishChange=function(e){var r=(void 0===e?{}:e).checked;t.context.mode===k.OwnerAvatarEditorMods.UPLOAD&&D(r?I.EVENT_SHARE_TO_FEED_TURN_ON:I.EVENT_SHARE_TO_FEED_TURN_OFF)},this.onStoryPublishChange=function(e){var r=(void 0===e?{}:e).checked;t.context.mode===k.OwnerAvatarEditorMods.UPLOAD&&D(r?I.EVENT_SHARE_TO_STORY_TURN_ON:I.EVENT_SHARE_TO_STORY_TURN_OFF)},this.showDoneBoxAfterAvatarChange=function(t,e,r,o){void 0===t&&(t=!1),void 0===e&&(e=!1),void 0===r&&(r=0),void 0===o&&(o=0);var n=[],a={tag:"a",className:"link",href:"/story"+r+"_"+o,onclick:"NewAvatarStory.openNewAvatarStory(event, "+r+", "+o+")",inner:(0,i.getLang)("mobile_stories_new_avatar_story_success_box_open_story")};t&&e?n.push({inner:(0,i.getLang)("profile_avatar_changed_with_post_and_story_title"),attrs:{style:"margin-bottom: 8px;"}},a):t?r>0?n.push({inner:(0,i.getLang)("profile_avatar_changed_with_post_title")}):n.push({inner:(0,i.getLang)("groups_avatar_changed_with_post_title")}):e?n.push({inner:(0,i.getLang)("profile_avatar_changed_with_story_title"),attrs:{style:"margin-bottom: 8px;"}},a):r>0?n.push({inner:(0,i.getLang)("profile_avatar_changed_title")}):n.push({inner:(0,i.getLang)("groups_avatar_changed_title")}),w.init({type:w.SNACKBAR_TYPE_SUCCESS,text:{inner:n},duration:5*L.SECOND})},this.selectPhoto=function(e,r,o){void 0===o&&(o="");var n=e?k.OwnerAvatarEditorMods.SELECT:k.OwnerAvatarEditorMods.EDIT;return t.context={ownerId:r,ownerName:o,mode:n,selectedPhotoId:e},t.initUI(o).then((function(o){return t.fetchUploadConfig({owner_id:r,photo_id:e,mode:n}).then((function(e){t.context.publisherStep=e.publisherStep,t.context.hash=e.hash,t.context.rotate=e.photo.rotate;var r=e.photo,i=e.rect;if(o.setSuccessHandler(t.thumbnailCreatorHandler),n===k.OwnerAvatarEditorMods.EDIT)return c(r.src,i[0],i[1],i[2],i[3]).then((function(t){o.getFromPhoto(t.src)}));var l=r.rotate%4*90;return function(t,e){return void 0===e&&(e=0),("string"==typeof t?(0,s.loadImage)(t):Promise.resolve(t)).then((function(t){var r,o=t.naturalWidth,n=t.naturalHeight;return 90!==e&&270!==e||(o=(r=(0,a.__read)([n,o],2))[0],n=r[1]),c(t,0,0,o,n,e)}))}(r.src,l).then((function(t){o.getFromPhoto(t.src)}))})).catch((function(t){throw t}))})).catch((function(t){console.error(t),w.init({text:(0,i.getLang)("mobile_unknown_error"),type:w.SNACKBAR_TYPE_ERROR})})),!1}}return t.prototype.initUI=function(t){var e=this;return void 0===t&&(t=""),(0,o.loadThumbnailCreator)().then((function(r){return e.thumbnailCreator=new r({minSourceWidth:400,minSourceHeight:400,minCroppedHeight:400,minCroppedWidth:400,maxSourceWidth:8192,maxSourceHeight:8192,maxCroppedHeight:8192,maxCroppedWidth:8192,previewBlock:(0,U.partConfigEnabled)("mvk_owner_new_avatar_preview_block")&&A({ownerName:t}),cropperOptions:{preview:".OwnerAvatarEditPreviewThumbnail__preview"}}),e.thumbnailCreator.initPopup(),e.thumbnailCreator}))},t.prototype.onUploadInputChange=function(t){var e=this;this.context={ownerId:Number(t.dataset.ownerId),ownerName:String(t.dataset.ownerName),mode:k.OwnerAvatarEditorMods.UPLOAD},this.prepareUpload().then((function(){var r;if(!(null===(r=null==t?void 0:t.files)||void 0===r?void 0:r[0]))throw new Error;return e.preparePhoto(t.files[0]).then((function(){e.startCrop()}))})).catch((function(t){console.error(t),w.init({text:"UploadError"===t.name?t.message:(0,i.getLang)("mobile_unknown_error"),type:w.SNACKBAR_TYPE_ERROR})}))},t.prototype.prepareUpload=function(){var t=this;return this.initUI(this.context.ownerName).then((function(){return t.fetchUploadConfig({owner_id:t.context.ownerId,mode:k.OwnerAvatarEditorMods.UPLOAD}).then((function(e){t.context.uploader=new S.UploadPhoto(e.uploadConfig),t.context.publisherStep=e.publisherStep})).catch((function(e){var r;throw null===(r=t.thumbnailCreator)||void 0===r||r.close(),e}))}))},t.prototype.preparePhoto=function(t){var e=this;return this.context.uploader?this.context.uploader.validate(t).then((function(){var r;return null===(r=e.context.uploader)||void 0===r?void 0:r.upload(t).then((function(t){return e.getPhotoSrcFromRawObject(e.context.ownerId,JSON.stringify(t)).then((function(r){e.context.photo=t,e.context.src=r}))}))})).catch((function(t){var r;if(null===(r=e.thumbnailCreator)||void 0===r||r.close(),t.text){var o=new Error(t.text);throw o.name="UploadError",o}})):Promise.reject()},t.prototype.startCrop=function(){if(!this.thumbnailCreator||!this.context.src)throw new Error;this.thumbnailCreator.setSuccessHandler(this.thumbnailCreatorHandler),this.thumbnailCreator.getFromPhoto(this.context.src)},t.prototype.saveOwnerAvatar=function(t,e){var r;void 0===t&&(t=!0),void 0===e&&(e=!0);var o=this.context.cropperResult,i=o.crop,a=o.cropped,l=null===(r=this.context.publisherStep)||void 0===r?void 0:r.new_avatar_story_data,s=(0,n.getCropString)(i.x,i.y,i.width,i.height,!1),u=Promise.resolve(void 0);e&&(null==l?void 0:l.shouldCreateNewAvatarStory)&&(u=b.initNewAvatarStory(l,this.context.ownerId,a.base64));var h=this.context.mode===k.OwnerAvatarEditorMods.UPLOAD?this.sendPhotoAvatarSave(this.context.ownerId,JSON.stringify(this.context.photo),s,t?0:1):this.sendPhotoAvatarSelect(this.context.ownerId,this.context.selectedPhotoId||"",s,this.context.rotate||0,this.context.hash||"",t?0:1);return Promise.all([h,u.then((function(t){return!((null==t?void 0:t.response)&&t.response.upload_result&&l)||b.saveNewAvatarStory(l,t.response.upload_result)}))]).then((function(t){return t[0]&&window.nav.go(t[0][0]),t}))},t.prototype.openPublisherStep=function(t){var e;if(!this.publisherStepPopup){var r=(0,E.default)({title:null===(e=this.context.publisherStep)||void 0===e?void 0:e.title,isLeftActionBack:!0,onLeftActionClick:"OwnerPhotoUpload2.closePublisherStep();",content:x({avatarSrc:t.cropped.base64,config:this.context.publisherStep,onSaveClick:"OwnerPhotoUpload2.onPublisherStepDone()",onPostPublishChange:"OwnerPhotoUpload2.onPostPublishChange",onStoryPublishChange:"OwnerPhotoUpload2.onStoryPublishChange"})}),o=O.default.elem(r);this.publisherStepPopup=C.default.open(o,!0)}},t.prototype.onPublisherStepDone=function(){var t,e=this,r=this.publisherStepPopup.querySelector('input[name="OwnerAvatarEditPublisherStepPublishPost"]').checked,o=null===(t=this.publisherStepPopup.querySelector('input[name="OwnerAvatarEditPublisherStepPublishStory"]'))||void 0===t?void 0:t.checked;y.default.setDisabled(this.publisherStepPopup.querySelector(".ModalPage__headerButton--close"),!0),y.default.setLoading(this.publisherStepPopup.querySelector(".OwnerAvatarEditPublisherStep__submitButton"),!0),this.saveOwnerAvatar(r,o).catch(console.error).then((function(t){var n=t[1];e.showDoneBoxAfterAvatarChange(r,o,e.context.ownerId,null==n?void 0:n.id)})).finally((function(){var t;null===(t=e.thumbnailCreator)||void 0===t||t.close(),e.closePublisherStep()}))},t.prototype.closePublisherStep=function(){var t;null===(t=this.thumbnailCreator)||void 0===t||t.unlockControlButtons(),C.default.close(this.publisherStepPopup),delete this.publisherStepPopup},t.prototype.fetchUploadConfig=function(t){return window.ajax.post("/profile.php",{act:"upload_owner_photo",oid:t.owner_id,mode:t.mode,photo_id:t.photo_id}).promise.then((function(t){if(!t.json)throw new Error;return t.json.data[0]}))},t.prototype.getPhotoSrcFromRawObject=function(t,e){return window.ajax.post("/profile.php",{act:"get_image_src",photo:e,oid:t}).promise.then((function(t){if(!t.json||!t.json.data)throw new Error;if(null===t.json.data[0]){var e=new Error(t.json.data[1]);throw e.name="UploadError",e}return t.json.data[0]}))},t.prototype.sendCropUpdate=function(t,e,r){return window.ajax.post("/profile.php",{act:"update_avatar_crop",square_crop:e,oid:t,hash:r}).promise.then((function(t){if(!t.json)throw new Error;return t.json.data}))},t.prototype.sendPhotoAvatarSelect=function(t,e,r,o,n,i){return void 0===i&&(i=0),window.ajax.post("/profile.php",{act:"select_avatar",rect_crop:r,rotate:o,photo_raw:e,oid:t,hash:n,skip_post:i}).promise.then((function(t){if(!t.json)throw new Error;return t.json.data}))},t.prototype.sendPhotoAvatarSave=function(t,e,r,o){return void 0===o&&(o=0),window.ajax.post("/profile.php",{act:"save_avatar",rect_crop:r,photo:e,oid:t,skip_post:o}).promise.then((function(t){if(!t.json)throw new Error;return t.json.data}))},t}());window.OwnerPhotoUpload2=R},57649:function(t,e,r){"use strict";r.d(e,{loadThumbnailCreator:function(){return i}});var o,n=r(79957);function i(){return o?Promise.resolve(o):Promise.all([r.e(1738),r.e(1070)]).then(r.bind(r,93285)).then((function(t){return o=t.ThumbnailCreator})).catch((function(t){return(0,n.statlogsValueEvent)("mvk_thumbnail_creator_event",null,"chunk_error",t.name)}))}},72455:function(t,e,r){"use strict";r.d(e,{getMaxPhotoSize:function(){return o},getCropString:function(){return n}});r(95036);function o(t){if(!Array.isArray(t)||!t.length)return null;var e=t.reduce((function(t,e){return t[e.type]=e,t}),{}),r=e.z||e.y||e.h||e.n||e.j||e.x||e.m||e.s;return r?{url:r.url||r.src,width:r.width,height:r.height}:null}function n(t,e,r,o,n){void 0===n&&(n=!1);var i=t+","+e+","+r;return n||(i=i+","+o),i}},11639:function(t,e,r){"use strict";r.d(e,{UploadPhoto:function(){return a}});var o=r(79573),n=r(69351);function i(t){return e=URL.createObjectURL(t),new Promise((function(t,r){var o=new Image;o.onload=function(){var e=Number(o.height),r=Number(o.width);t([r,e])},o.onerror=function(){r()},o.onabort=function(){r()},o.src=e}));var e}var a=function(){function t(t,e){this.config=(0,o.__assign)({allowedTypes:["*"]},t),this.progressCallback=e}return t.prototype.validate=function(t){var e=this.config,r=e.constraints,a=e.allowedTypes,l=e.lang,s=!1;return a&&(s=a.some((function(e){return"*"===e||e===t.type}))),s?r?i(t).then((function(t){var e=r.maxWidth,i=r.minWidth,a=r.maxHeight,s=r.minHeight,u=r.maxAspectRatio,h=r.minAspectRatio,c=(0,o.__read)(t,2),d=c[0],p=c[1],v=d/p;if(d>e||p>a){var _=(l["error_"+n.UploadPhotoErrorCodes.IMAGE_TOO_BIG]||"").replace("{width}",String(e)).replace("{height}",String(a));return Promise.reject({code:n.UploadPhotoErrorCodes.IMAGE_TOO_BIG,text:_})}if(d<i||p<s){_=(l["error_"+n.UploadPhotoErrorCodes.IMAGE_TOO_SMALL]||"").replace("{width}",String(i)).replace("{height}",String(s));return Promise.reject({code:n.UploadPhotoErrorCodes.IMAGE_TOO_SMALL,text:_})}return h&&h>v||u&&v>u?Promise.reject({code:n.UploadPhotoErrorCodes.BAD_ASPECT_RATIO,text:l["error_"+n.UploadPhotoErrorCodes.BAD_ASPECT_RATIO]}):Promise.resolve(null)})).catch((function(t){return t&&t.text&&t.code?Promise.reject(t):Promise.reject({code:n.UploadPhotoErrorCodes.UNKNOWN,text:l["error_"+n.UploadPhotoErrorCodes.UNKNOWN]})})):Promise.resolve(null):Promise.reject({code:n.UploadPhotoErrorCodes.NOT_ALLOWED_EXTENSION,text:l["error_"+n.UploadPhotoErrorCodes.NOT_ALLOWED_EXTENSION]})},t.prototype.upload=function(t,e,r){var o=this;return void 0===r&&(r="file1"),this.validate(t).then((function(){return new Promise((function(i,a){var l=new XMLHttpRequest,s=new FormData;s.append(r,t),l.open("POST",e||o.config.url,!0),l.onreadystatechange=function(){if(l.readyState===XMLHttpRequest.DONE&&200===l.status){var t=void 0;try{l.responseText&&(t=JSON.parse(l.responseText))}catch(t){a({code:n.UploadPhotoErrorCodes.UNKNOWN,text:o.config.lang["error_"+n.UploadPhotoErrorCodes.UNKNOWN]})}i(t)}},l.onerror=function(){a({code:n.UploadPhotoErrorCodes.UPLOAD,text:o.config.lang["error_"+n.UploadPhotoErrorCodes.UPLOAD]})},l.upload.onprogress=function(t){o.progressCallback&&o.progressCallback(t.loaded,t.total)},l.send(s)}))}))},t}()},69351:function(t,e,r){"use strict";var o,n,i;r.d(e,{UploadPhotoErrorCodes:function(){return o},OwnerAvatarEditorMods:function(){return i}}),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.UPLOAD=1]="UPLOAD",t[t.NOT_ALLOWED_EXTENSION=2]="NOT_ALLOWED_EXTENSION",t[t.IMAGE_TOO_SMALL=3]="IMAGE_TOO_SMALL",t[t.IMAGE_TOO_BIG=4]="IMAGE_TOO_BIG",t[t.BAD_ASPECT_RATIO=5]="BAD_ASPECT_RATIO"}(o||(o={})),function(t){t.UPLOADED="uploaded",t.EXISTED="existed"}(n||(n={})),function(t){t[t.UPLOAD=1]="UPLOAD",t[t.SELECT=2]="SELECT",t[t.EDIT=3]="EDIT"}(i||(i={}))}},function(t){"use strict";t.O(0,[4578,1777,4736,5456,5790,3898,5411,6855,6199,490,410,6444,8592,7219,6429],(function(){return e=1626,t(t.s=e);var e}));t.O()}]);